# üë®‚Äç‚öïÔ∏è Doctor Invite & Connection Management - Complete Guide

## üìã Overview

This guide covers all doctor-side APIs for the invite and connection management system integrated into `doctor/app_mvc.py`.

---

## üéØ Complete API List

### **‚úÖ 6 Doctor-Side APIs - NOW AVAILABLE**

| # | Method | Endpoint | Auth | Description |
|---|--------|----------|------|-------------|
| 1 | POST | `/api/doctor/generate-invite` | ‚úÖ Required | Generate invite code for patient email |
| 2 | GET | `/api/invite/verify/<code>` | ‚ùå Public | Verify invite code validity (no auth) |
| 3 | GET | `/api/doctor/invites` | ‚úÖ Required | Get all invites generated by doctor |
| 4 | GET | `/api/doctor/connection-requests` | ‚úÖ Required | View pending connection requests |
| 5 | POST | `/api/doctor/respond-to-request` | ‚úÖ Required | Accept or reject connection request |
| 6 | POST | `/api/doctor/remove-connection` | ‚úÖ Required | Remove patient connection |
| 7 | GET | `/api/doctor/connected-patients` | ‚úÖ Required | List all connected patients |

---

## üìñ Detailed API Documentation

### **1. Generate Invite Code**

**Endpoint:** `POST /api/doctor/generate-invite`  
**Auth:** Required (Doctor Token)

**Description:** Doctor generates a unique invite code for a specific patient email.

**Request Headers:**
```
Authorization: Bearer <doctor_token>
Content-Type: application/json
```

**Request Body:**
```json
{
  "patient_email": "patient@example.com",
  "expires_in_days": 7,
  "message": "I would like to invite you for prenatal care."
}
```

**Request Fields:**
- `patient_email` (required) - Patient's email address
- `expires_in_days` (optional, default: 7) - Code validity in days (1-30)
- `message` (optional) - Personal message to patient

**Success Response (201):**
```json
{
  "success": true,
  "message": "Invite code generated for patient@example.com",
  "invite": {
    "invite_code": "A1B-C2D-E3F",
    "patient_email": "patient@example.com",
    "expires_at": "2025-10-28T10:30:00Z",
    "status": "active",
    "usage_limit": 1,
    "deep_link": "myapp://invite/A1B-C2D-E3F"
  }
}
```

**Error Responses:**
- `400` - Invalid email format / Connection already exists
- `403` - Not authenticated as doctor
- `404` - Doctor not found
- `500` - Server error

---

### **2. Verify Invite Code (Public)**

**Endpoint:** `GET /api/invite/verify/<invite_code>`  
**Auth:** None (Public endpoint)

**Description:** Verify if an invite code is valid. No authentication required.

**Path Parameter:**
- `invite_code` - The invite code (format: XXX-XXX-XXX)

**Example:**
```
GET /api/invite/verify/A1B-C2D-E3F
```

**Success Response (200):**
```json
{
  "success": true,
  "valid": true,
  "message": "Valid invite code",
  "doctor": {
    "name": "Dr. John Smith",
    "specialty": "Obstetrics & Gynecology",
    "hospital": "City General Hospital"
  },
  "invite_info": {
    "expires_at": "2025-10-28T10:30:00Z",
    "remaining_uses": 1,
    "custom_message": "I would like to invite you for prenatal care."
  }
}
```

**Error Responses:**
- `400` - Invalid format / Expired / Already used
- `404` - Invalid invite code

---

### **3. Get My Invites**

**Endpoint:** `GET /api/doctor/invites`  
**Auth:** Required (Doctor Token)

**Description:** Get all invite codes generated by the authenticated doctor.

**Query Parameters:**
- `status` (optional) - Filter by status: `active`, `expired`, `used` (leave empty for all)

**Examples:**
```
GET /api/doctor/invites                    # All invites
GET /api/doctor/invites?status=active      # Active only
GET /api/doctor/invites?status=expired     # Expired only
```

**Success Response (200):**
```json
{
  "success": true,
  "invites": [
    {
      "invite_code": "A1B-C2D-E3F",
      "patient_email": "patient1@example.com",
      "custom_message": "Welcome message",
      "status": "active",
      "usage_count": 0,
      "usage_limit": 1,
      "created_at": "2025-10-21T10:00:00Z",
      "expires_at": "2025-10-28T10:00:00Z",
      "sent_via": "api"
    }
  ],
  "total_count": 1,
  "filter": "active"
}
```

---

### **4. Get Connection Requests**

**Endpoint:** `GET /api/doctor/connection-requests`  
**Auth:** Required (Doctor Token)

**Description:** View all connection requests from patients.

**Query Parameters:**
- `status` (optional, default: pending) - Filter: `pending`, `active`, `rejected`, `all`

**Examples:**
```
GET /api/doctor/connection-requests                    # Pending only
GET /api/doctor/connection-requests?status=all         # All requests
GET /api/doctor/connection-requests?status=active      # Active connections
```

**Success Response (200):**
```json
{
  "success": true,
  "requests": [
    {
      "connection_id": "CONN1729871524000123",
      "request_id": "CONN1729871524000123",
      "patient_id": "PAT175975384628ED6C",
      "patient_name": "Jane Doe",
      "patient_email": "jane.doe@example.com",
      "patient_mobile": "9876543210",
      "patient_photo": null,
      "message": "Hello Doctor, I would like to connect with you for my pregnancy care.",
      "connection_type": "primary",
      "status": "pending",
      "requested_at": "2025-10-21T14:30:00Z",
      "patient_info": {
        "age": 28,
        "blood_type": "O+",
        "is_pregnant": true,
        "pregnancy_week": 12
      }
    }
  ],
  "total_count": 1,
  "status_filter": "pending"
}
```

---

### **5. Accept or Reject Connection Request**

**Endpoint:** `POST /api/doctor/respond-to-request`  
**Auth:** Required (Doctor Token)

**Description:** Doctor accepts or rejects a patient's connection request.

**Request Body:**
```json
{
  "connection_id": "CONN1729871524000123",
  "action": "accept",
  "message": "Welcome! Looking forward to helping you."
}
```

**Request Fields:**
- `connection_id` (required) - ID of the connection request
- `action` (required) - Must be `"accept"` or `"reject"`
- `message` (optional) - Response message to patient

**Success Response (200) - Accept:**
```json
{
  "success": true,
  "message": "Patient connection accepted",
  "connection": {
    "connection_id": "CONN1729871524000123",
    "status": "active",
    "updated_at": "2025-10-21T15:00:00Z"
  }
}
```

**Success Response (200) - Reject:**
```json
{
  "success": true,
  "message": "Patient connection rejected",
  "connection": {
    "connection_id": "CONN1729871524000123",
    "status": "rejected",
    "updated_at": "2025-10-21T15:00:00Z"
  }
}
```

**Error Responses:**
- `400` - Invalid action / Connection not pending
- `403` - Not your connection request
- `404` - Connection not found

---

### **6. Remove Patient Connection**

**Endpoint:** `POST /api/doctor/remove-connection`  
**Auth:** Required (Doctor Token)

**Description:** Doctor ends connection with a patient.

**Request Body:**
```json
{
  "connection_id": "CONN1729871524000123",
  "reason": "Patient has relocated to another city."
}
```

**Request Fields:**
- `connection_id` (required) - ID of the connection to remove
- `reason` (optional) - Reason for removal

**Success Response (200):**
```json
{
  "success": true,
  "message": "Connection removed successfully",
  "connection": {
    "connection_id": "CONN1729871524000123",
    "status": "removed"
  }
}
```

**Error Responses:**
- `403` - Not your connection
- `404` - Connection not found

---

### **7. Get Connected Patients**

**Endpoint:** `GET /api/doctor/connected-patients`  
**Auth:** Required (Doctor Token)

**Description:** Get all patients with active connections to the doctor.

**Success Response (200):**
```json
{
  "success": true,
  "patients": [
    {
      "connection_id": "CONN1729871524000123",
      "patient_id": "PAT175975384628ED6C",
      "name": "Jane Doe",
      "age": 28,
      "email": "jane.doe@example.com",
      "mobile": "9876543210",
      "profile_photo": null,
      "pregnancy_info": {
        "is_pregnant": true,
        "pregnancy_week": 12,
        "expected_delivery_date": "2026-05-15"
      },
      "connection_info": {
        "connected_since": "2025-10-15T10:30:00Z",
        "connection_type": "primary",
        "status": "active"
      },
      "statistics": {
        "total_appointments": 3,
        "completed_appointments": 1,
        "cancelled_appointments": 0
      }
    }
  ],
  "summary": {
    "total_count": 1,
    "active_pregnancies": 1
  }
}
```

---

## üîÑ Complete Workflows

### **Workflow 1: Doctor Invites Patient**

```
Step 1: Doctor generates invite
POST /api/doctor/generate-invite
Response: invite_code = "ABC-XYZ-123"

Step 2: Doctor shares code with patient
(via email, SMS, or app)

Step 3: Patient verifies code (optional)
GET /api/invite/verify/ABC-XYZ-123
Response: Shows doctor info

Step 4: Patient accepts invite
POST /api/invite/accept (patient service)
Body: {"invite_code": "ABC-XYZ-123"}

Step 5: Connection created
Status: "active" immediately
Doctor's patient count incremented
```

### **Workflow 2: Patient Requests Doctor**

```
Step 1: Patient searches for doctors
GET /api/invite/search-doctors (patient service)

Step 2: Patient sends connection request
POST /api/invite/request-connection (patient service)
Body: {
  "doctor_id": "D17597286260221902",
  "message": "I would like to connect..."
}
Status: "pending"

Step 3: Doctor views pending requests
GET /api/doctor/connection-requests?status=pending

Step 4: Doctor accepts or rejects
POST /api/doctor/respond-to-request
Body: {
  "connection_id": "CONN123",
  "action": "accept",
  "message": "Welcome!"
}

Step 5: Connection updated
Status: "active" or "rejected"
Patient receives notification
```

---

## üß™ Testing with Postman

### **Import Collection**
1. Open Postman
2. Import `Doctor_Invite_Connection_Postman_Collection.json`
3. Collection loaded with 7 requests

### **Set Up Environment**
```
base_url = http://localhost:5000
doctor_token = (auto-saved after login)
```

### **Test Sequence**
1. **Doctor Login** ‚Üí Get token (auto-saved)
2. **Generate Invite** ‚Üí Get invite_code (auto-saved)
3. **Verify Invite** ‚Üí Check validity
4. **Get My Invites** ‚Üí See all codes
5. **Get Requests** ‚Üí View pending (auto-saves connection_id)
6. **Accept Request** ‚Üí Approve connection
7. **Get Connected Patients** ‚Üí See active connections

---

## üîê Security Features

### **Invite Code Security**
- ‚úÖ SHA256 hashing
- ‚úÖ Single-use codes
- ‚úÖ Expiration dates (1-30 days)
- ‚úÖ Max attempt protection (5 attempts)
- ‚úÖ Email validation

### **Connection Security**
- ‚úÖ Ownership verification
- ‚úÖ Status validation
- ‚úÖ Audit logging
- ‚úÖ JWT authentication
- ‚úÖ Permission checks

---

## üìä Database Collections

### **invite_codes**
Stores doctor invite codes
- Unique index on `invite_code`
- Index on `doctor_id`
- Auto-expires based on `expires_at`

### **connections**
Stores doctor-patient connections
- Unique index on `connection_id`
- Compound index on `doctor_id` + `patient_id`
- Tracks connection lifecycle

---

## üöÄ Quick Start

### **1. Start Server**
```bash
cd doctor
python app_mvc.py
```

### **2. Test Health**
```bash
curl http://localhost:5000/health
```

### **3. Login as Doctor**
```bash
curl -X POST http://localhost:5000/doctor-login \
  -H "Content-Type: application/json" \
  -d '{
    "login_identifier": "doctor@example.com",
    "password": "yourpassword"
  }'
```

### **4. Generate Invite**
```bash
curl -X POST http://localhost:5000/api/doctor/generate-invite \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "patient_email": "patient@example.com",
    "expires_in_days": 7,
    "message": "Welcome!"
  }'
```

### **5. Test Public Verification**
```bash
curl http://localhost:5000/api/invite/verify/ABC-XYZ-123
```

---

## üé® Flutter Integration

### **Doctor App Code Examples**

#### **Generate Invite**
```dart
Future<Map<String, dynamic>> generateInvite(String patientEmail, String message) async {
  final response = await http.post(
    Uri.parse('$baseUrl/api/doctor/generate-invite'),
    headers: {
      'Authorization': 'Bearer $doctorToken',
      'Content-Type': 'application/json',
    },
    body: jsonEncode({
      'patient_email': patientEmail,
      'expires_in_days': 7,
      'message': message,
    }),
  );
  
  return jsonDecode(response.body);
}
```

#### **Get Pending Requests**
```dart
Future<List<ConnectionRequest>> getPendingRequests() async {
  final response = await http.get(
    Uri.parse('$baseUrl/api/doctor/connection-requests?status=pending'),
    headers: {
      'Authorization': 'Bearer $doctorToken',
    },
  );
  
  final data = jsonDecode(response.body);
  return (data['requests'] as List)
      .map((req) => ConnectionRequest.fromJson(req))
      .toList();
}
```

#### **Accept Request**
```dart
Future<bool> acceptConnectionRequest(String connectionId, String message) async {
  final response = await http.post(
    Uri.parse('$baseUrl/api/doctor/respond-to-request'),
    headers: {
      'Authorization': 'Bearer $doctorToken',
      'Content-Type': 'application/json',
    },
    body: jsonEncode({
      'connection_id': connectionId,
      'action': 'accept',
      'message': message,
    }),
  );
  
  final data = jsonDecode(response.body);
  return data['success'] == true;
}
```

#### **Get Connected Patients**
```dart
Future<List<Patient>> getConnectedPatients() async {
  final response = await http.get(
    Uri.parse('$baseUrl/api/doctor/connected-patients'),
    headers: {
      'Authorization': 'Bearer $doctorToken',
    },
  );
  
  final data = jsonDecode(response.body);
  return (data['patients'] as List)
      .map((p) => Patient.fromJson(p))
      .toList();
}
```

---

## üêõ Common Issues & Solutions

### **Issue 1: "Doctor authentication required"**

**Symptom:**
```json
{"success": false, "error": "Doctor authentication required"}
```

**Cause:** JWT token doesn't contain `doctor_id`

**Solution:** Ensure doctor login generates token with doctor_id:
```python
# In doctor_controller.py login method
payload = {
    "doctor_id": doctor_data['doctor_id'],
    "email": doctor_data['email'],
    "user_type": "doctor"
}
```

---

### **Issue 2: "Connection already exists"**

**Symptom:**
```json
{"success": false, "error": "Connection already exists with this patient"}
```

**Cause:** Patient already has active/pending connection with doctor

**Solution:** 
- Check existing connections first
- Or use different patient email

---

### **Issue 3: "Invalid invite code format"**

**Symptom:**
```json
{"success": false, "error": "Invalid invite code format"}
```

**Cause:** Code doesn't match XXX-XXX-XXX pattern

**Solution:** Use exact format from generate-invite response

---

## üìà Statistics & Metrics

The system tracks:
- ‚úÖ Total invites generated
- ‚úÖ Active/expired/used invites
- ‚úÖ Total connection requests
- ‚úÖ Accepted/rejected requests
- ‚úÖ Active patient count
- ‚úÖ Connection statistics per patient

---

## üîÆ Future Enhancements

### **Phase 1: Email Integration** (High Priority)
- Send invite codes via email
- Connection request notifications
- Connection accepted/rejected emails

### **Phase 2: Advanced Features**
- Bulk invite generation
- Invite code analytics
- Connection history reports
- Patient engagement metrics

### **Phase 3: Mobile App Deep Links**
- Universal links for iOS
- App links for Android
- Automatic invite acceptance

---

## üìû Support

### **Files to Reference:**
- API Implementation: `doctor/app_mvc.py` (lines 493-1048)
- Database Setup: `doctor/models/database.py`
- Helper Functions: `doctor/utils/helpers.py`
- Postman Collection: `doctor/Doctor_Invite_Connection_Postman_Collection.json`
- Merge Documentation: `doctor/INVITE_CONNECTION_MERGE_COMPLETE.md`

### **Testing:**
- Use Postman collection for comprehensive testing
- Check server logs for detailed error messages
- Use `/debug` endpoints for troubleshooting

---

## ‚úÖ Verification Checklist

Before deploying, verify:

- [ ] Server starts without errors
- [ ] Database collections created
- [ ] Indexes created successfully
- [ ] Doctor login works and returns token with doctor_id
- [ ] Can generate invite code
- [ ] Can verify invite code (public endpoint)
- [ ] Can view invite list
- [ ] Can view connection requests
- [ ] Can accept connection request
- [ ] Can reject connection request
- [ ] Can remove connection
- [ ] Can view connected patients
- [ ] Postman collection works
- [ ] Flutter app integration tested

---

## üéâ Summary

**‚úÖ ALL 4 Missing Doctor-Side APIs Successfully Added:**

1. ‚úÖ **Send Invite to Patient** - Doctor generates invite code
2. ‚úÖ **Get Pending Requests** - Doctor views patient requests
3. ‚úÖ **Accept Request** - Doctor approves connection
4. ‚úÖ **Reject Request** - Doctor declines connection

**Plus 3 additional management endpoints:**
5. ‚úÖ **Get My Invites** - List all generated codes
6. ‚úÖ **Remove Connection** - End patient connection
7. ‚úÖ **Get Connected Patients** - View all active connections

**Total:** 7 fully functional doctor-side APIs integrated into `doctor/app_mvc.py`

---

**Ready to use! Start the server and test with Postman.** üöÄ

**Document Version:** 1.0  
**Last Updated:** October 21, 2025












